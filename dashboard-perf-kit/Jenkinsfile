pipeline {
  agent any
  environment {
    ENVIRONMENT = "QA"
    BASE_URL    = "https://qa.example.com"
    USER_EMAIL  = credentials('perf_user_email')
    USER_PASS   = credentials('perf_user_password')
    BUILD_ID    = "${env.BUILD_NUMBER}-${new Date().format('yyyyMMddHHmmss')}"
    PYTHON      = "python3"
  }
  stages {
    stage('Checkout') {
      steps { checkout scm }
    }
    stage('Measure') {
      steps {
        dir('dashboard-perf') {
          sh '''
            mvn -DskipTests clean test               -Denvironment=$ENVIRONMENT               -DbaseUrl=$BASE_URL               -Dusername=$USER_EMAIL               -Dpassword=$USER_PASS               -DtargetSelector="#dashboardReadyMarker"               -DperfThresholdMs=3000               -DbuildId=$BUILD_ID               -Dsurefire.suiteXmlFiles=testng.xml
          '''
        }
      }
    }
    stage('Analyze') {
      steps {
        sh '''
          $PYTHON analyze_performance.py --history_csv results/dashboard_performance_history.csv --environment $ENVIRONMENT
        '''
      }
    }
  }
  post {
    always {
      archiveArtifacts artifacts: 'results/**, dashboard-perf/reports/**', fingerprint: true
    }
  }
}
